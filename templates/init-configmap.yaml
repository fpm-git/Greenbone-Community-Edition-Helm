apiVersion: v1
kind: ConfigMap
metadata:
  name: init-scripts-config
  namespace: {{ template "openvas.namespace" . }}
  labels:
    {{- include "openvas.labels" . | nindent 4 }}
data:
  init-postgres.sh: |
    #!/bin/sh
    set -u

    log() { echo "[INFO] $*"; }
    warn() { echo "[WARN] $*"; }
    err() { echo "[ERROR] $*" >&2; }

    run() {
      log "RUN: $*"
      "$@"
      rc=$?
      if [ $rc -ne 0 ]; then
        err "Command failed (rc=$rc): $*"
        return $rc
      fi
      return 0
    }

    dump_fs() {
      err "Filesystem dump (best-effort):"
      for p in \
        /etc/postgresql \
        "/etc/postgresql/${POSTGRES_VERSION:-}" \
        "/etc/postgresql/${POSTGRES_VERSION:-}/main" \
        /var/lib/postgresql \
        "/var/lib/postgresql/${POSTGRES_VERSION:-}" \
        /run/postgresql \
        /var/run/postgresql \
        /mnt/postgresql \
      ; do
        if [ -e "$p" ]; then
          err "  - ls -la $p:"
          ls -la "$p" 2>&1 | sed 's/^/[ERROR]      /' >&2
        else
          err "  - MISSING: $p"
        fi
      done

      if command -v pg_lsclusters >/dev/null 2>&1; then
        err "pg_lsclusters:"
        (pg_lsclusters 2>&1 || true) | sed 's/^/[ERROR]   /' >&2
      fi
    }

    die() {
      err "$*"
      err "Context:"
      err "  POSTGRES_VERSION=${POSTGRES_VERSION:-<unset>}"
      err "  POSTGRES_DATA=${POSTGRES_DATA:-<unset>}"
      err "  POSTGRES_HBA_CONF=${POSTGRES_HBA_CONF:-<unset>}"
      err "  POSTGRES_SETUP_DIR=${POSTGRES_SETUP_DIR:-<unset>}"
      err "  POSTGRES_SOCKET_DIR=${POSTGRES_SOCKET_DIR:-<unset>}"
      err "  PATH=$PATH"
      dump_fs
      exit 1
    }

    log "Checking environment variables"
    [ -z "${POSTGRES_USER:-}" ] && POSTGRES_USER="gvmd"
    [ -z "${POSTGRES_DATA:-}" ] && POSTGRES_DATA="/var/lib/postgresql"
    [ -z "${POSTGRES_HOST_AUTH_METHOD:-}" ] && POSTGRES_HOST_AUTH_METHOD="md5"
    [ -z "${POSTGRES_VERSION:-}" ] && POSTGRES_VERSION=13

    POSTGRES_DB=gvmd
    POSTGRES_HBA_CONF="/etc/postgresql/$POSTGRES_VERSION/main/pg_hba.conf"

    # IMPORTANT: make setup marker versionless so upgrades donâ€™t re-init forever
    POSTGRES_SETUP_DIR="/mnt/postgresql/main"
    POSTGRES_SOCKET_DIR="/run/postgresql"

    log "POSTGRES_USER=$POSTGRES_USER"
    log "POSTGRES_DATA=$POSTGRES_DATA"
    log "POSTGRES_HOST_AUTH_METHOD=$POSTGRES_HOST_AUTH_METHOD"
    log "POSTGRES_DB=$POSTGRES_DB"
    log "POSTGRES_VERSION=$POSTGRES_VERSION"
    log "POSTGRES_HBA_CONF=$POSTGRES_HBA_CONF"
    log "POSTGRES_SETUP_DIR=$POSTGRES_SETUP_DIR"
    log "POSTGRES_SOCKET_DIR=$POSTGRES_SOCKET_DIR"

    log "Checking if PostgreSQL is already set up"
    if [ -d "$POSTGRES_SETUP_DIR" ]; then
      log "PostgreSQL already set up at $POSTGRES_SETUP_DIR, skipping initialization."
      exit 0
    fi

    log "Sanity checks for expected Debian cluster layout"
    command -v pg_ctlcluster >/dev/null 2>&1 || die "pg_ctlcluster missing"

    HBA_DIR="$(dirname "$POSTGRES_HBA_CONF")"
    [ -d "$HBA_DIR" ] || die "Expected directory does not exist: $HBA_DIR"
    [ -w "$HBA_DIR" ] || die "Directory is not writable: $HBA_DIR"

    log "Removing started file if present"
    rm -f "$POSTGRES_DATA/started" || die "Failed removing $POSTGRES_DATA/started"

    log "Writing pg_hba.conf"
    {
      echo "local all all trust"
      echo "host all all all $POSTGRES_HOST_AUTH_METHOD"
    } > "$POSTGRES_HBA_CONF" 2>/dev/null || die "Failed to write $POSTGRES_HBA_CONF"

    log "Starting PostgreSQL cluster (using default Debian socket dir)"
    # Do NOT force -k /tmp; Debian cluster uses /run/postgresql by default
    run pg_ctlcluster "$POSTGRES_VERSION" main start || die "Failed to start cluster '$POSTGRES_VERSION main'"

    log "Waiting for server readiness on socket dir $POSTGRES_SOCKET_DIR"
    if command -v pg_isready >/dev/null 2>&1; then
      i=0
      while [ $i -lt 30 ]; do
        pg_isready -h "$POSTGRES_SOCKET_DIR" -U postgres >/dev/null 2>&1 && break
        i=$((i+1))
        sleep 1
      done
      pg_isready -h "$POSTGRES_SOCKET_DIR" -U postgres >/dev/null 2>&1 || die "Postgres not ready on $POSTGRES_SOCKET_DIR after 30s"
    else
      warn "pg_isready missing; proceeding without readiness check"
    fi

    log "Checking if user $POSTGRES_USER exists"
    USER_EXISTS="$(echo "SELECT 1 FROM pg_roles WHERE rolname = '$POSTGRES_USER'" | psql --host="$POSTGRES_SOCKET_DIR" -U postgres -d postgres --tuples-only 2>/dev/null || true)"
    if [ -z "$USER_EXISTS" ]; then
      log "Creating user $POSTGRES_USER"
      run createuser --host="$POSTGRES_SOCKET_DIR" -U postgres -DRS "$POSTGRES_USER" || die "createuser failed"
    else
      log "User $POSTGRES_USER already exists"
    fi

    if [ -n "${POSTGRES_PASSWORD:-}" ]; then
      log "Setting password for $POSTGRES_USER"
      echo "ALTER ROLE $POSTGRES_USER PASSWORD '$POSTGRES_PASSWORD';" | \
        psql --host="$POSTGRES_SOCKET_DIR" -U postgres -d postgres 2>/dev/null || die "Failed setting password"
    fi

    log "Checking if database $POSTGRES_DB exists"
    DB_EXISTS="$(echo "SELECT 1 FROM pg_database WHERE datname = '$POSTGRES_DB';" | psql --host="$POSTGRES_SOCKET_DIR" -U postgres -d postgres --tuples-only 2>/dev/null || true)"
    if [ -z "$DB_EXISTS" ]; then
      log "Creating database $POSTGRES_DB owned by $POSTGRES_USER"
      run createdb --host="$POSTGRES_SOCKET_DIR" -U postgres -O "$POSTGRES_USER" "$POSTGRES_DB" || die "createdb failed"
    else
      log "Database $POSTGRES_DB already exists"
    fi

    log "Checking if role dba exists"
    DBA_EXISTS="$(echo "SELECT 1 FROM pg_roles WHERE rolname = 'dba';" | psql --host="$POSTGRES_SOCKET_DIR" -U postgres -d "$POSTGRES_DB" --tuples-only 2>/dev/null || true)"
    if [ -z "$DBA_EXISTS" ]; then
      log "Creating role dba and granting to $POSTGRES_USER"
      run psql --host="$POSTGRES_SOCKET_DIR" -U postgres -d "$POSTGRES_DB" -c "create role dba with superuser noinherit;" || die "Failed creating role dba"
      run psql --host="$POSTGRES_SOCKET_DIR" -U postgres -d "$POSTGRES_DB" -c "grant dba to $POSTGRES_USER;" || die "Failed granting role dba"
    else
      log "Role dba already exists"
    fi

    log "Checking for extension uuid-ossp"
    UUID_OSSP_EXTENSION_EXISTS="$(echo "SELECT 1 FROM pg_extension WHERE extname = 'uuid-ossp';" | psql --host="$POSTGRES_SOCKET_DIR" -U postgres -d "$POSTGRES_DB" --tuples-only 2>/dev/null || true)"
    if [ -z "$UUID_OSSP_EXTENSION_EXISTS" ]; then
      log 'Creating extension uuid-ossp'
      run psql --host="$POSTGRES_SOCKET_DIR" -U postgres -d "$POSTGRES_DB" -c 'create extension "uuid-ossp";' || die "Failed creating extension uuid-ossp"
    else
      log "Extension uuid-ossp already exists"
    fi

    log "Checking for extension pgcrypto"
    PGCRYPTO_EXTENSION_EXISTS="$(echo "SELECT 1 FROM pg_extension WHERE extname = 'pgcrypto';" | psql --host="$POSTGRES_SOCKET_DIR" -U postgres -d "$POSTGRES_DB" --tuples-only 2>/dev/null || true)"
    if [ -z "$PGCRYPTO_EXTENSION_EXISTS" ]; then
      log "Creating extension pgcrypto"
      run psql --host="$POSTGRES_SOCKET_DIR" -U postgres -d "$POSTGRES_DB" -c 'create extension "pgcrypto";' || die "Failed creating extension pgcrypto"
    else
      log "Extension pgcrypto already exists"
    fi

    log "Checking for extension pg-gvm"
    PG_GVM_EXTENSION_EXISTS="$(echo "SELECT 1 FROM pg_extension WHERE extname = 'pg-gvm';" | psql --host="$POSTGRES_SOCKET_DIR" -U postgres -d "$POSTGRES_DB" --tuples-only 2>/dev/null || true)"
    if [ -z "$PG_GVM_EXTENSION_EXISTS" ]; then
      log "Creating extension pg-gvm"
      run psql --host="$POSTGRES_SOCKET_DIR" -U postgres -d "$POSTGRES_DB" -c 'create extension "pg-gvm";' || die "Failed creating extension pg-gvm"
    else
      log "Extension pg-gvm already exists"
    fi

    log "Stopping PostgreSQL cluster"
    run pg_ctlcluster "$POSTGRES_VERSION" main stop || warn "Failed to stop cluster '$POSTGRES_VERSION main'"

    log "Copying data to PersistentVolume"
    run cp -ra /var/lib/postgresql/* /mnt/postgresql/ || die "Failed copying data to /mnt/postgresql"

    # Create marker so future runs skip, regardless of version
    run mkdir -p "$POSTGRES_SETUP_DIR" || die "Failed creating setup marker dir $POSTGRES_SETUP_DIR"

    log "PostgreSQL initialization complete"
